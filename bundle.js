class Lib {
    static scales = {
        'chromatic': [
            1,
            1,
            1,
            1,
            1,
            1,
            1,
            1,
            1,
            1,
            1,
            1
        ],
        'minor': [
            2,
            1,
            2,
            2,
            1,
            2,
            2
        ],
        'natural minor': [
            2,
            1,
            2,
            2,
            1,
            2,
            2
        ],
        'major': [
            2,
            2,
            1,
            2,
            2,
            2,
            1
        ],
        'ionian': [
            2,
            2,
            1,
            2,
            2,
            2,
            1
        ],
        'dorian': [
            2,
            1,
            2,
            2,
            2,
            1,
            2
        ],
        'phrygian': [
            1,
            2,
            2,
            2,
            1,
            2,
            2
        ],
        'lydian': [
            2,
            2,
            2,
            1,
            2,
            2,
            1
        ],
        'mixolydian': [
            2,
            2,
            1,
            2,
            2,
            1,
            2
        ],
        'aeolian': [
            2,
            1,
            2,
            2,
            1,
            2,
            2
        ],
        'locrian': [
            1,
            2,
            2,
            1,
            2,
            2,
            2
        ],
        'melodic minor': [
            2,
            1,
            2,
            2,
            2,
            2,
            1
        ],
        'jazz minor': [
            2,
            1,
            2,
            2,
            2,
            2,
            1
        ],
        'dorian #7': [
            2,
            1,
            2,
            2,
            2,
            2,
            1
        ],
        'phrygian #6': [
            1,
            2,
            2,
            2,
            2,
            1,
            2
        ],
        'dorian b2': [
            1,
            2,
            2,
            2,
            2,
            1,
            2
        ],
        'lydian augmented': [
            2,
            2,
            2,
            2,
            1,
            2,
            1
        ],
        'lydian #5': [
            2,
            2,
            2,
            2,
            1,
            2,
            1
        ],
        'overtone': [
            2,
            2,
            2,
            1,
            2,
            1,
            2
        ],
        'acoustic': [
            2,
            2,
            2,
            1,
            2,
            1,
            2
        ],
        'lydian dominant': [
            2,
            2,
            2,
            1,
            2,
            1,
            2
        ],
        'lydian b7': [
            2,
            2,
            2,
            1,
            2,
            1,
            2
        ],
        'mixolydian #4': [
            2,
            2,
            2,
            1,
            2,
            1,
            2
        ],
        'mixolydian #11': [
            2,
            2,
            2,
            1,
            2,
            1,
            2
        ],
        'dominant #11': [
            2,
            2,
            2,
            1,
            2,
            1,
            2
        ],
        'mixolydian b6': [
            2,
            2,
            1,
            2,
            1,
            2,
            2
        ],
        'mixolydian b13': [
            2,
            2,
            1,
            2,
            1,
            2,
            2
        ],
        'aeolian dominant': [
            2,
            2,
            1,
            2,
            1,
            2,
            2
        ],
        'aeolian major': [
            2,
            2,
            1,
            2,
            1,
            2,
            2
        ],
        'melodic major': [
            2,
            2,
            1,
            2,
            1,
            2,
            2
        ],
        'aeolian #3': [
            2,
            2,
            1,
            2,
            1,
            2,
            2
        ],
        'locrian #2': [
            2,
            1,
            2,
            1,
            2,
            2,
            2
        ],
        'half diminished': [
            2,
            1,
            2,
            1,
            2,
            2,
            2
        ],
        'locrian natural 9': [
            2,
            1,
            2,
            1,
            2,
            2,
            2
        ],
        'super locrian': [
            1,
            2,
            1,
            2,
            2,
            2,
            2
        ],
        'altered': [
            1,
            2,
            1,
            2,
            2,
            2,
            2
        ],
        'altered dominant': [
            1,
            2,
            1,
            2,
            2,
            2,
            2
        ],
        'pomeroy': [
            1,
            2,
            1,
            2,
            2,
            2,
            2
        ],
        'ravel': [
            1,
            2,
            1,
            2,
            2,
            2,
            2
        ],
        'diminished whole tone': [
            1,
            2,
            1,
            2,
            2,
            2,
            2
        ],
        'dominant whole tone': [
            1,
            2,
            1,
            2,
            2,
            2,
            2
        ],
        'locrian b4': [
            1,
            2,
            1,
            2,
            2,
            2,
            2
        ],
        'ionian #1': [
            1,
            2,
            1,
            2,
            2,
            2,
            2
        ],
        'harmonic minor': [
            2,
            1,
            2,
            2,
            1,
            3,
            1
        ],
        'aeolian #7': [
            2,
            1,
            2,
            2,
            1,
            3,
            1
        ],
        'locrian #6': [
            1,
            2,
            2,
            1,
            3,
            1,
            2
        ],
        'ionian #5': [
            2,
            2,
            1,
            3,
            1,
            2,
            1
        ],
        'dorian #4': [
            2,
            1,
            3,
            1,
            2,
            1,
            2
        ],
        'dorian #11': [
            2,
            1,
            3,
            1,
            2,
            1,
            2
        ],
        'phrygian major': [
            1,
            3,
            1,
            2,
            1,
            2,
            2
        ],
        'phrygian dominant': [
            1,
            3,
            1,
            2,
            1,
            2,
            2
        ],
        'phrygian #3': [
            1,
            3,
            1,
            2,
            1,
            2,
            2
        ],
        'lydian #2': [
            3,
            1,
            2,
            1,
            2,
            2,
            1
        ],
        'alt dominant': [
            1,
            2,
            1,
            2,
            2,
            1,
            3
        ],
        'mixolydian #1': [
            1,
            2,
            1,
            2,
            2,
            1,
            3
        ],
        'harmonic major': [
            2,
            2,
            1,
            2,
            1,
            3,
            1
        ],
        'ionian b6': [
            2,
            2,
            1,
            2,
            1,
            3,
            1
        ],
        'dorian b5': [
            2,
            1,
            2,
            1,
            3,
            1,
            2
        ],
        'phrygian b4': [
            1,
            2,
            1,
            3,
            1,
            2,
            2
        ],
        'lydian b3': [
            2,
            1,
            3,
            1,
            2,
            2,
            1
        ],
        'mixolydian b2': [
            1,
            3,
            1,
            2,
            2,
            1,
            2
        ],
        'aeolian b1': [
            3,
            1,
            2,
            2,
            1,
            2,
            1
        ],
        'locrian b7': [
            1,
            2,
            2,
            1,
            2,
            1,
            3
        ],
        'pentatonic major': [
            2,
            2,
            3,
            2,
            3
        ],
        'pentatonic minor': [
            3,
            2,
            2,
            3,
            2
        ],
        'pentatonic blues': [
            3,
            2,
            1,
            1,
            3,
            2
        ],
        'pentatonic neutral': [
            2,
            3,
            2,
            3,
            2
        ],
        'blues': [
            3,
            2,
            1,
            1,
            3,
            2
        ],
        'minor blues': [
            3,
            2,
            1,
            1,
            3,
            2
        ],
        'major blues': [
            2,
            1,
            1,
            3,
            2,
            3
        ],
        'whole': [
            2,
            2,
            2,
            2,
            2,
            2
        ],
        'half whole': [
            1,
            2,
            1,
            2,
            1,
            2,
            1,
            2
        ],
        'dominant diminished': [
            1,
            2,
            1,
            2,
            1,
            2,
            1,
            2
        ],
        'whole half': [
            2,
            1,
            2,
            1,
            2,
            1,
            2,
            1
        ],
        'diminished': [
            2,
            1,
            2,
            1,
            2,
            1,
            2,
            1
        ],
        'algerian': [
            2,
            1,
            2,
            1,
            1,
            1,
            3,
            1
        ],
        'arabic': [
            2,
            2,
            1,
            1,
            2,
            2,
            2
        ],
        'byzantine': [
            1,
            3,
            1,
            2,
            1,
            3,
            2
        ],
        'chinese': [
            4,
            2,
            1,
            4,
            1
        ],
        'egyptian': [
            2,
            3,
            2,
            3,
            2
        ],
        'eight tone spanish': [
            1,
            2,
            1,
            1,
            1,
            2,
            2,
            2
        ],
        'enigmatic': [
            1,
            3,
            2,
            2,
            2,
            1,
            1
        ],
        'enigmatic minor': [
            1,
            2,
            3,
            1,
            3,
            1,
            1
        ],
        'geez': [
            2,
            1,
            2,
            2,
            1,
            2,
            2
        ],
        'hindu': [
            2,
            2,
            1,
            2,
            1,
            2,
            2
        ],
        'hirajoshi': [
            1,
            4,
            1,
            4,
            2
        ],
        'hungarian': [
            2,
            1,
            3,
            1,
            1,
            2,
            1
        ],
        'japanese': [
            1,
            4,
            2,
            3,
            2
        ],
        'oriental': [
            1,
            3,
            1,
            1,
            3,
            1,
            2
        ],
        'romanian minor': [
            2,
            1,
            3,
            1,
            2,
            1,
            2
        ],
        'spanish gypsy': [
            1,
            3,
            1,
            2,
            1,
            2,
            2
        ],
        'maqam': [
            1,
            3,
            1,
            2,
            1,
            3,
            1
        ],
        'bebop major': [
            2,
            2,
            1,
            2,
            1,
            1,
            2,
            1
        ],
        'bebop': [
            2,
            2,
            1,
            2,
            1,
            1,
            2,
            1
        ],
        'bebop minor': [
            2,
            1,
            1,
            1,
            2,
            2,
            1,
            2
        ],
        'bebop dominant': [
            2,
            2,
            1,
            2,
            2,
            1,
            1,
            1
        ],
        'bebop dorian': [
            2,
            1,
            2,
            2,
            2,
            1,
            1,
            1
        ],
        'nine tone': [
            2,
            1,
            1,
            2,
            1,
            1,
            1,
            2,
            1
        ]
    };
    static get scaleNames() {
        return Object.keys(this.scales);
    }
    static sharps = [
        'C',
        'C#',
        'D',
        'D#',
        'E',
        'F',
        'F#',
        'G',
        'G#',
        'A',
        'A#',
        'B'
    ];
    static flats = [
        'C',
        'Db',
        'D',
        'Eb',
        'E',
        'F',
        'Gb',
        'G',
        'Ab',
        'A',
        'Bb',
        'B'
    ];
    static alts = [
        'B#',
        '_',
        '_',
        '_',
        'Fb',
        'E#',
        '_',
        '_',
        '_',
        '_',
        '_',
        'Cb'
    ];
    static blackKeys = [
        'C#',
        'Db',
        'D#',
        'Eb',
        'F#',
        'Gb',
        'G#',
        'Ab',
        'A#',
        'Bb'
    ];
    static notesPerOctave = 12;
    static totalOctaves = 3;
    static get totalNotes() {
        return this.notesPerOctave * this.totalOctaves;
    }
}
class Parser {
    static transposeNote(noteString, amount) {
        let noteIndex = Math.max(Lib.sharps.indexOf(noteString), Lib.flats.indexOf(noteString), Lib.alts.indexOf(noteString));
        if (noteIndex < 0) return noteString;
        noteIndex = (noteIndex + amount) % Lib.notesPerOctave;
        if (noteIndex < 0) noteIndex += Lib.notesPerOctave;
        return amount < 0 ? Lib.flats[noteIndex] : Lib.sharps[noteIndex];
    }
    static extractNotes(query) {
        return (query.match(/[ABCDEFG]b?#?/g) || []).map((note)=>{
            const altIndex = Lib.alts.indexOf(note);
            return altIndex >= 0 ? Lib.sharps[altIndex] : note;
        });
    }
    static extractSymbols(query) {
        return (query.match(/[ABCDEFG](b?#?)([^ABCDEFG])*/g) || []).map((symbol)=>symbol.trim().replace(/\s+/g, ' ')
        );
    }
    static extractRoot(query) {
        const results = query.match(/[ABCDEFG]b?#?/) || [];
        return results.length > 0 ? results[0] : null;
    }
    static noteStringToIndex(noteString) {
        let noteIndex = Lib.sharps.indexOf(noteString) + 1 || Lib.flats.indexOf(noteString) + 1 || Lib.alts.indexOf(noteString) + 1;
        return noteIndex ? noteIndex : null;
    }
    static indexToNoteString(index, sharp = true) {
        return sharp ? Lib.sharps[(index - 1) % Lib.notesPerOctave] : Lib.flats[(index - 1) % Lib.notesPerOctave];
    }
    static extractFlats(query) {
        return (query.replace(/([ABCDEFG](b|#)?)-?\d+/g, '').match(/(b|-)\d+/g) || []).map((str)=>parseInt(str.slice(1), 10)
        ).reduce((acc, num)=>!acc.includes(num) ? [
                ...acc,
                num
            ] : acc
        , []);
    }
    static extractSharps(query) {
        return (query.replace(/([ABCDEFG](b|#)?)\+?\d+/g, '').match(/(#|\+)\d+/g) || []).map((str)=>+str.slice(1)
        ).reduce((acc, num)=>!acc.includes(num) ? [
                ...acc,
                num
            ] : acc
        , []);
    }
    static noteIndexToFirstOctave(noteIndex) {
        const zeroIndex = noteIndex - 1;
        return zeroIndex % Lib.notesPerOctave + 1;
    }
}
const px = (p)=>`${p}px`
;
const BL = {
    W: 48,
    H: 200
};
const WH = {
    W: 80,
    H: 300
};
class UIKey {
    el;
    noteStr;
    octave;
    pressed = false;
    highlighted = false;
    root = false;
    isSmall = false;
    mousedownHandler = (e, key)=>{
    };
    mouseupHandler = (e, key)=>{
    };
    mouseoverHandler = (e, key)=>{
    };
    constructor(noteStr, octave1){
        this.noteStr = noteStr;
        this.octave = octave1;
        this.el = document.createElement('div');
        this.el.addEventListener('mousedown', (e)=>this.mousedownHandler(e, this)
        );
        this.el.addEventListener('mouseup', (e)=>this.mouseupHandler(e, this)
        );
        this.el.addEventListener('mouseover', (e)=>this.mouseoverHandler(e, this)
        );
        this.el.id = `o${this.octave}n${this.noteIndex}`;
        this.render();
    }
    get isBlack() {
        return Lib.blackKeys.includes(this.noteStr);
    }
    get noteIndex() {
        const idx = Parser.noteStringToIndex(this.noteStr);
        return idx === null ? 0 : idx;
    }
    get MIDINote() {
        return 60 + this.octave * 12 + this.noteIndex - 1;
    }
    render() {
        const { el , isBlack , isSmall , highlighted , pressed , root , noteStr: noteStr1  } = this;
        el.className = 'cursor-pointer flex items-end justify-center rounded-b ';
        el.innerHTML = `<div class="flex rounded-full ${root ? 'bg-white text-black' : ''} ${isSmall ? 'text-sm w-5 h-5' : 'w-8 h-8'} justify-center items-center bg-opacity-90">${noteStr1}</div>`;
        if (isBlack) {
            const width = isSmall ? BL.W * 0.5 : BL.W;
            const height = isSmall ? BL.H * 0.5 : BL.H;
            el.className += 'z-10 text-white ';
            el.className += isSmall ? 'border-b-4 border-r-2 border-l-2 pb-1 ' : 'border-b-8 border-r-4 border-l-4 pb-2 ';
            if (pressed) {
                el.className += 'bg-gray-800 border-purple-700';
            } else if (highlighted) {
                el.className += 'bg-gray-600 border-blue-400';
            } else {
                el.className += 'bg-black border-gray-700';
            }
            el.style.width = px(width);
            el.style.height = px(height);
            el.style.marginLeft = px(-width / 2);
            el.style.marginRight = px(-width / 2);
        } else {
            const width = isSmall ? WH.W * 0.5 : WH.W;
            const height = isSmall ? WH.H * 0.5 : WH.H;
            el.className += 'border-gray-500 text-black ';
            el.className += isSmall ? 'border-b border-r pb-2 ' : 'border-b border-r-2 pb-4 ';
            if (pressed) {
                el.className += 'bg-purple-400';
            } else if (highlighted) {
                el.className += 'bg-blue-200';
            } else {
                el.className += 'bg-white';
            }
            el.style.width = px(width);
            el.style.height = px(height);
        }
        return this;
    }
    small() {
        this.isSmall = true;
        this.render();
    }
    highlight(root = false) {
        this.highlighted = true;
        this.root = root;
        return this.render();
    }
    unhighlight() {
        this.root = false;
        this.highlighted = false;
        return this.render();
    }
    press(root = false) {
        this.pressed = true;
        this.root = root;
        return this.render();
    }
    unpress() {
        this.root = false;
        this.pressed = false;
        return this.render();
    }
}
function range(size) {
    return [
        ...Array(size).keys()
    ];
}
class UIPiano {
    el = document.createElement('div');
    keys;
    startNoteIndex;
    _title = '';
    onKeyHover = (key)=>{
    };
    onKeyDown = (key)=>{
    };
    onKeyUp = (key)=>{
    };
    constructor(startNoteIndex = 0, numKeys = Lib.notesPerOctave * 3){
        this.startNoteIndex = startNoteIndex;
        this.keys = range(numKeys).map((n)=>Parser.indexToNoteString(n + startNoteIndex + 1)
        ).map((noteStr1, i)=>{
            const key = new UIKey(noteStr1, Math.floor((i + startNoteIndex) / Lib.notesPerOctave));
            key.mouseupHandler = this.keyEvent.bind(this);
            key.mousedownHandler = this.keyEvent.bind(this);
            key.mouseoverHandler = this.keyEvent.bind(this);
            return key;
        });
        this.render();
        window.addEventListener('midi', (e)=>{
            this.midiEvent(e.detail.action, e.detail.note);
        });
    }
    render() {
        this.el.remove();
        this.el = document.createElement('div');
        this.el.className = 'flex flex-row justify-center relative ';
        this.el.append(...this.keys.map((k)=>k.el
        ));
        if (this._title) {
            const titleEl = document.createElement('div');
            titleEl.className = 'absolute -bottom-10';
            titleEl.innerHTML = this._title;
            this.el.append(titleEl);
        }
        return this;
    }
    title(titleStr) {
        this._title = titleStr;
        return this.render();
    }
    small() {
        this.keys.forEach((key)=>key.small()
        );
        return this.render();
    }
    setNotes(noteIndexes, fill = false) {
        this.keys.forEach((key, i)=>{
            const shouldHightlight = fill ? noteIndexes.map(Parser.noteIndexToFirstOctave).includes(Parser.noteIndexToFirstOctave(i + this.startNoteIndex + 1)) : noteIndexes.includes(i + this.startNoteIndex + 1);
            if (shouldHightlight) {
                const isRoot = (i + this.startNoteIndex + 1) % Lib.notesPerOctave === noteIndexes[0] % Lib.notesPerOctave;
                key.highlight(isRoot);
            } else {
                key.unhighlight();
            }
        });
        return this;
    }
    keyEvent(e, key) {
        if (e.type === 'mousedown') this.onKeyDown(key);
    }
    midiEvent(action, note) {
        if (action === 'on') {
            this.keys.find((key)=>key.MIDINote === note
            )?.press();
        } else if (action === 'off') {
            this.keys.find((key)=>key.MIDINote === note
            )?.unpress();
        }
    }
}
class Chord {
    static getNotesFromSymbol(symbol, octave = 0) {
        const rootString = Parser.extractRoot(symbol);
        if (!rootString) return [];
        const rootIndex = Parser.noteStringToIndex(rootString);
        if (!rootIndex) return [];
        const flats = Parser.extractFlats(symbol);
        const sharps = Parser.extractSharps(symbol);
        const contains = (arr)=>Boolean(arr.find((s)=>symbol.includes(s)
            ))
        ;
        const interval = Array(14).fill(rootIndex);
        interval[3] += 4;
        interval[5] += 7;
        interval[6] += 0;
        interval[7] += 0;
        interval[9] += 0;
        interval[11] += 0;
        interval[13] += 0;
        if (symbol.includes('m') && !symbol.includes('maj') || symbol.includes(rootString + '-') || symbol.includes('dim')) {
            interval[3] = rootIndex + 3;
        }
        if (symbol.includes('sus4')) {
            interval[3] = rootIndex + 5;
        }
        if (symbol.includes('sus2')) {
            interval[3] = rootIndex + 2;
        }
        if (contains([
            'dim',
            'b5'
        ])) {
            interval[5] = rootIndex + 6;
        }
        if (contains([
            '#5',
            '+5',
            '+7',
            'aug'
        ])) {
            interval[5] = rootIndex + 8;
        }
        if (symbol.includes('6')) {
            interval[6] = rootIndex + 9;
        }
        if (contains([
            '7',
            '9',
            '11',
            '13'
        ])) {
            interval[7] = rootIndex + 10;
        }
        if (contains([
            'M7',
            'M9',
            'M11',
            'M13',
            'maj7',
            'maj9',
            'maj11',
            'maj13'
        ])) {
            interval[7] = rootIndex + 11;
        }
        if (symbol.includes('dim') && interval[7] == rootIndex + 10) {
            interval[7]--;
        }
        if (!flats.includes(9) && !sharps.includes(9) && contains([
            '9',
            '11',
            '13'
        ])) {
            interval[9] = rootIndex + 14;
        }
        if (!flats.includes(11) && !sharps.includes(11) && contains([
            '11',
            '13'
        ])) {
            interval[11] = rootIndex + 17;
        }
        if (!flats.includes(13) && !sharps.includes(13) && symbol.includes('13')) {
            interval[13] = rootIndex + 21;
        }
        const majorScaleIntervals = Lib.scales['major'];
        flats.forEach((flatIndex)=>{
            let flatValue = rootIndex - 1;
            for(let noteIndex = 0; noteIndex < flatIndex - 1; noteIndex++){
                flatValue += majorScaleIntervals[noteIndex % majorScaleIntervals.length];
            }
            interval.push(flatValue || Lib.notesPerOctave);
        });
        sharps.forEach((sharpIndex)=>{
            let sharpValue = rootIndex + 1;
            for(let noteIndex = 0; noteIndex < sharpIndex - 1; noteIndex++){
                sharpValue += majorScaleIntervals[noteIndex % majorScaleIntervals.length];
            }
            interval.push(sharpValue || Lib.notesPerOctave);
        });
        return Array.from(new Set(interval)).map((i)=>(i || Lib.notesPerOctave) + Lib.notesPerOctave * octave
        ).sort((a, b)=>a - b
        );
    }
}
class Scale {
    static isScale(symbol) {
        const re = new RegExp('[ABCDEFG](#|b)?\\s+(' + Lib.scaleNames.join('|') + ')', 'gi');
        return re.test(symbol);
    }
    static getNotesFromSymbol(symbol) {
        if (!this.isScale(symbol)) return [];
        const rootString = Parser.extractRoot(symbol);
        if (!rootString) return [];
        const rootIndex = Parser.noteStringToIndex(rootString);
        if (!rootIndex) return [];
        const symbolScale = symbol.replace(rootString, '').trim();
        const scaleName = Lib.scaleNames.find((name)=>symbolScale === name
        ) || null;
        if (!scaleName) return [];
        const octave2 = Lib.scales[scaleName].reduce((notes, interval)=>[
                ...notes,
                notes.slice(-1)[0] + interval
            ]
        , [
            rootIndex
        ]);
        return octave2;
    }
}
class Chords {
    static MINOR = 'minor';
    static MAJOR = 'major';
    useTriads = true;
    notes = [];
    keyType;
    minorMods = [
        'min',
        'dim',
        'maj',
        'min',
        'min',
        'maj',
        'maj'
    ];
    majorMods = [
        'maj',
        'min',
        'min',
        'maj',
        'maj',
        'min',
        'dim'
    ];
    minor7Mods = [
        'min',
        'min7b5',
        'maj',
        'min',
        'min',
        'maj',
        'dom'
    ];
    major7Mods = [
        'maj7',
        'min7',
        'min7',
        'maj7',
        'dom7',
        'min7',
        'min7b5'
    ];
    numerals = [
        'i',
        'ii',
        'iii',
        'iv',
        'v',
        'vi',
        'vii'
    ];
    constructor(noteStr1, keyType = Chords.MINOR){
        this.keyType = keyType;
        this.notes = Scale.getNotesFromSymbol(`${noteStr1} ${keyType}`);
    }
    getModifier(degree) {
        let modifiers = this.keyType === Chords.MINOR ? this.useTriads ? this.minorMods : this.minor7Mods : this.useTriads ? this.majorMods : this.major7Mods;
        return modifiers[degree - 1];
    }
    getChordSymbol(degree) {
        const noteIndexFirstOctave = Parser.noteIndexToFirstOctave(this.notes[degree - 1]);
        const noteStr2 = Lib.sharps[noteIndexFirstOctave - 1];
        return `${noteStr2}${this.getModifier(degree)}`;
    }
    getChordNumeral(degree) {
        const modifier = this.getModifier(degree);
        let numeral = this.numerals[degree - 1];
        if (modifier.includes('min')) {
            numeral = numeral.toLowerCase();
        } else {
            numeral = numeral.toUpperCase();
        }
        if (modifier.includes('dim')) {
            numeral = numeral.toLocaleLowerCase() + '<sup>o</sup>';
        }
        return `${numeral}`;
    }
    getChord(degree) {
        const symbol = this.getChordSymbol(degree);
        return Chord.getNotesFromSymbol(symbol);
    }
    sevenths() {
        this.useTriads = false;
        return this;
    }
    triads() {
        this.useTriads = true;
        return this;
    }
    getProgression(degrees = range(7).map((d)=>d + 1
    )) {
        return degrees.map((deg)=>this.getChord(deg)
        );
    }
    getProgressionSymbols(degrees = range(7).map((d)=>d + 1
    )) {
        return degrees.map((deg)=>this.getChordSymbol(deg)
        );
    }
    getProgressionNumerals(degrees = range(7).map((d)=>d + 1
    )) {
        return degrees.map((deg)=>this.getChordSymbol(deg)
        );
    }
}
class UIModeSelector {
    el;
    modeButtons = [];
    mode = 'scale';
    onchange = (mode)=>{
    };
    static SCALE = 'scale';
    static CHORD = 'chord';
    static modes = [
        'scale',
        'chord'
    ];
    constructor(){
        this.el = document.createElement('div');
        UIModeSelector.modes.forEach((mode)=>{
            const button = document.createElement('div');
            button.setAttribute('data-mode', mode);
            button.addEventListener('mousedown', (e)=>this.modeSelect(mode)
            );
            this.modeButtons.push(button);
            this.el.append(button);
        });
        this.render();
    }
    render() {
        const { el , modeButtons , mode  } = this;
        el.className = 'cursor-pointer flex items-end justify-center ';
        modeButtons.forEach((button)=>{
            button.innerHTML = button.getAttribute('data-mode') || '';
            button.className = 'p-4 ';
            button.className += mode === button.getAttribute('data-mode') ? 'bg-gray-200' : 'bg-gray-100';
        });
        return this;
    }
    modeSelect(mode) {
        this.mode = mode;
        this.onchange(mode);
        return this.render();
    }
}
document.body.className = 'h-screen flex flex-col items-center justify-center bg-gray-100';
const piano = new UIPiano();
const pianos = [
    piano
];
const modeSelector = new UIModeSelector();
const textInputClass = 'p-4 text-center text-xl my-4 outline-none border';
const scaleInput = document.createElement('input');
scaleInput.type = 'text';
scaleInput.value = 'major';
scaleInput.className = textInputClass;
scaleInput.onclick = ()=>scaleInput.select()
;
const chordInput = document.createElement('input');
chordInput.type = 'text';
chordInput.value = 'm';
chordInput.className = textInputClass;
chordInput.onclick = ()=>chordInput.select()
;
const title = document.createElement('div');
title.className = 'absolute top-0 right-0 p-8 text-gray-500 text-right';
title.innerHTML = `<span class="p-2 px-4 bg-white text-black border rounded" style="font-size:2rem;">\n        Notary\n    </span>\n    <br>\n    <a class="mr-2 text-white bg-black p-1 px-2 border rounded hover:bg-gray-600" href="https://github.com/bbales/notary">\n        @bbales\n    </a>`;
const chordContainer = document.createElement('div');
chordContainer.className = 'mt-16 grid grid-flow-row grid-cols-4 w-screen gap-y-16 ';
document.body.append(title);
document.body.append(modeSelector.el);
document.body.append(scaleInput);
document.body.append(chordInput);
document.body.append(piano.el);
document.body.append(chordContainer);
let selectedNoteStr = 'C';
let selectedOctave = 1;
const update = ()=>{
    let noteIndexes = [];
    if (modeSelector.mode === UIModeSelector.SCALE) {
        chordInput.style.display = 'none';
        scaleInput.style.display = 'block';
        noteIndexes = Scale.getNotesFromSymbol(`${selectedNoteStr} ${scaleInput.value}`);
        piano.setNotes(noteIndexes, true);
    } else if (modeSelector.mode === UIModeSelector.CHORD) {
        chordInput.style.display = 'block';
        scaleInput.style.display = 'none';
        noteIndexes = Chord.getNotesFromSymbol(`${selectedNoteStr}${chordInput.value} `, selectedOctave);
        piano.setNotes(noteIndexes);
    }
    chordContainer.innerHTML = '';
    const chords = new Chords(selectedNoteStr, scaleInput.value.includes('min') ? 'minor' : 'major');
    pianos.length = 0;
    pianos.push(piano);
    chords.getProgression().forEach((chord, i)=>{
        let startNoteIndex1 = chord[0] - 2;
        if (startNoteIndex1 <= 0) {
            startNoteIndex1 += Lib.notesPerOctave;
            chord = chord.map((noteIndex)=>noteIndex += Lib.notesPerOctave
            );
        }
        const p = new UIPiano(startNoteIndex1, Lib.notesPerOctave + 1).setNotes(chord).small().title(`<b>${chords.getChordNumeral(i + 1)}</b> <span class="text-gray-400">|</span> ${chords.getChordSymbol(i + 1)}`);
        chordContainer.append(p.el);
        pianos.push(p);
    });
};
piano.onKeyDown = (key)=>{
    selectedNoteStr = key.noteStr;
    selectedOctave = key.octave;
    update();
};
modeSelector.onchange = update;
scaleInput.onkeyup = update;
chordInput.onkeyup = update;
window.onkeyup = (e)=>{
    const { key  } = e;
    if (key === 'ArrowUp') {
        selectedNoteStr = Parser.transposeNote(selectedNoteStr, 1);
    } else if (key === 'ArrowDown') {
        selectedNoteStr = Parser.transposeNote(selectedNoteStr, -1);
    }
    update();
};
update();
const nomidi = document.createElement('div');
nomidi.style.display = 'none';
nomidi.className = 'absolute bottom-0 right-0 p-4 m-4 text-gray-500 text-right rounded border ';
document.body.append(nomidi);
if ('requestMIDIAccess' in navigator) {
    navigator.requestMIDIAccess().then((access)=>{
        const inputs = access.inputs.values();
        for (var input of inputs)input.onmidimessage = (message)=>handleMIDIMessage(message.data)
        ;
        nomidi.className += 'bg-green-100 border-green-300';
        access.onstatechange = (e)=>{
            nomidi.innerHTML = `Connected to ${e.port.name}`;
            nomidi.style.display = 'block';
        };
    });
} else {
    nomidi.className += 'bg-yellow-100 border-yellow-300';
    nomidi.innerHTML = `Your browser does not support WebMIDI`;
    nomidi.style.display = 'block';
}
const handleMIDIMessage = (bytes)=>{
    const command = bytes[0];
    var note = bytes[1];
    var velocity = bytes.length > 2 ? bytes[2] : 0;
    switch(command){
        case 144:
            if (velocity > 0) {
                window.dispatchEvent(new CustomEvent('midi', {
                    detail: {
                        note,
                        action: 'on'
                    }
                }));
            } else {
                window.dispatchEvent(new CustomEvent('midi', {
                    detail: {
                        note,
                        action: 'off'
                    }
                }));
            }
            break;
        case 128:
            window.dispatchEvent(new CustomEvent('midi', {
                detail: {
                    note,
                    action: 'off'
                }
            }));
            break;
    }
};
